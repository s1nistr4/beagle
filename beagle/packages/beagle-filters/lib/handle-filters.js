"use strict";var dirname=require("path").dirname,constantinople=require("constantinople"),walk=require("beagle-walk"),error=require("beagle-error"),runFilter=require("./run-filter");module.exports=handleFilters;function handleFilters(a,b,c,d){function e(a){var b=a.name;if(d&&d[b]&&(b=d[b],d[b]))throw error("FILTER_ALISE_CHAIN","The filter \""+a.name+"\" is an alias for \""+b+"\", which is an alias for \""+d[b]+"\".  Pug does not support chains of filter aliases.",a);return b}return c=c||{},walk(a,function(a){function f(a,c,d,f){try{var g=e(a);return b&&b[g]?b[g](c,d):runFilter(g,c,d,h,f)}catch(b){if("UNKNOWN_FILTER"===b.code)throw error(b.code,b.message,a);throw b}}function g(a,c,d,g){var h=e(a);return b&&b[h]?b[h].renderBuffer?b[h].renderBuffer(d.raw,g):b[h](d.str,g):f(a,c,g,"renderFile")}var h=a.filename?dirname(a.filename):null;if("Filter"===a.type){handleNestedFilters(a,b,c,d);var i=getBodyAsText(a),j=getAttributes(a,c);j.filename=a.filename,a.type="Text",a.val=f(a,i,j)}else if("RawInclude"===a.type&&a.filters.length){var k=a.filters.pop(),j=getAttributes(k,c),l=j.filename=a.file.fullPath;a.type="Text",a.val=g(k,l,a.file,j),a.filters.slice().reverse().forEach(function(b){var d=getAttributes(b,c);d.filename=l,a.val=f(b,a.val,d)}),a.filters=void 0,a.file=void 0}},{includeDependencies:!0}),a}function handleNestedFilters(a,b,c,d){a.block.nodes[0]&&"Filter"===a.block.nodes[0].type&&(a.block.nodes[0]=handleFilters(a.block,b,c,d).nodes[0])}function getBodyAsText(a){return a.block.nodes.map(function(a){return a.val}).join("")}function getAttributes(a,b){var c={};a.attrs.forEach(function(b){try{c[b.name]=!0===b.val||constantinople.toConstant(b.val)}catch(b){if(/not constant/.test(b.message))throw error("FILTER_OPTION_NOT_CONSTANT",b.message+" All filters are rendered compile-time so filter options must be constants.",a);throw b}});var d=b[a.name]||{};return Object.keys(d).forEach(function(a){c.hasOwnProperty(a)||(c[a]=d[a])}),c}