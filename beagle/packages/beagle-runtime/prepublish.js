"use strict";var fs=require("fs"),uglify=require("uglify-js"),runtime=require("./");try{fs.mkdirSync(__dirname+"/lib")}catch(a){if("EEXIST"!==a.code)throw a}var source=fs.readFileSync(__dirname+"/index.js","utf8"),ast=uglify.parse(source),dependencies={},internals={dependencies:!0,internals:!0},sources={};ast.body.forEach(function(a){var b;switch(a.TYPE){case"Defun":b=a.name.name;break;case"Var":b=a.definitions[0].name.name}if(b&&/^pug\_/.test(b)){b=b.replace(/^pug\_/,"");var c=uglify.minify(source.substring(a.start.pos,a.end.endpos),{fromString:!0}).code;if(sources[b]=c,dependencies[b]=[],"Defun"===a.TYPE){var d=uglify.parse(c);d.figure_out_scope();var e=d.globals.map(function(a,b){return b});dependencies[b]=e.filter(function(a){return /^pug\_/.test(a)}).map(function(a){return a.replace(/^pug\_/,"")})}runtime[b]||(internals[b]=!0)}}),Object.keys(dependencies).forEach(function(a){dependencies[a]=dependencies[a].sort()}),fs.writeFileSync(__dirname+"/lib/dependencies.js","module.exports = "+JSON.stringify(dependencies,null,2)+"\n"),fs.writeFileSync(__dirname+"/lib/internals.js","module.exports = "+JSON.stringify(internals,null,2)+"\n"),fs.writeFileSync(__dirname+"/lib/sources.js","module.exports = "+JSON.stringify(sources,null,2)+"\n");